/* WebSQL (v0.2) Paul Sayre */
(function(l){var f=l.WebSQL=function(q,s,t,u,v){var r=l.openDatabase&&l.openDatabase(q,s||"1.0",t||q,u||5E6,v),m=r&&{query:function(e){var j=f.Deferred(),h=p(e)?e:arguments;m.rawTx(function(n){var g=f.Deferred(),c,a,d,b,o,i,e,k=g.reject;b=0;for(o=h.length;b<o;b++)if(c=h[b],a=h[b+1],"function"===typeof c&&(c=c.toString(),c=c.substr(c.indexOf("/*!")+3),c=c.substr(0,c.lastIndexOf("*/"))),(d=/^\s*(?:INSERT|REPLACE)\s+INTO\s+\w+\s*\(([^\)]+)\)\s*$/i.exec(c))&&d[1]&&(c+=" VALUES ("+Array(d[1].split(",").length).join("?,")+"?)"),p(a))if(b+=1,p(a[0])){d=0;for(i=a.length;d<i;d++)b+1===o&&d+1===i&&(e=g.resolve),n.executeSql(c,a[d],e,k)}else b+1===o&&(e=g.resolve),n.executeSql(c,a,e,k);else b+1===o&&(e=g.resolve),n.executeSql(c,[],e,k);g.fail(j.reject).done(function(c,a){var b=null,d,g;if(a){if(g=a.rows){b=[];for(d=0;d<g.length;d++)b[d]=g.item(d)}if(b&&0===b.length)try{b.insertId=a.insertId}catch(e){b.insertId=null}else b.insertId=null}j.resolve(b)})});return j.promise()},rawTx:function(e){r.transaction(e)},getTableNames:function(){var e=$.Deferred();m.query('SELECT tbl_name FROM sqlite_master WHERE type = "table" AND tbl_name NOT REGEXP "^(__|sqlite_).*"').fail(e.reject).done(function(f){var h,n=[];for(h=0;h<f.length;h++)n[h]=f[h].tbl_name;e.resolve(n)});return e.promise()},dump:function(e,j){var h=f.Deferred(),j=!1!==j;switch(e){default:m.query('SELECT * FROM sqlite_master WHERE tbl_name NOT REGEXP "^(__|sqlite_).*" ORDER BY CASE type WHEN "table" THEN 1 WHEN "index" THEN 2 ELSE 3 END').fail(h.reject).done(function(e){var g={},c=[],a,d;for(d=0;a=e[d];d++)if(a.sql)switch(a.type){case "table":g[a.tbl_name]={schema:{table:a.sql,indexes:[]}};j&&function(b){var a=f.Deferred();m.query("SELECT * FROM "+b).fail(a.reject).done(function(c){delete c.insertId;g[b].data=c;a.resolve()});c.push(a)}(a.tbl_name);break;case "index":g[a.tbl_name].schema.indexes.push(a.sql)}f.when.apply(f,c).fail(h.reject).done(function(){h.resolve(g)})});break;case "sql":m.dump("json",j).fail(h.reject).done(function(e){var g=[],c,a,d,b,f,i,j,k;for(k in e)if(Object.prototype.hasOwnProperty.call(e,k)&&(c=e[k],g.push(c.schema.table),g=g.concat(c.schema.indexes),c.data&&0<c.data.length)){f=[];a=c.data[0];for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&f.push(/\s/.test(b)?"`"+b+"`":b);f=f.join(", ");i=[];for(d=0;a=c.data[d];d++){i[d]=[];for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&(j="number"===typeof a[b]?a[b]:null===a[b]||void 0===a[b]?"NULL":'"'+a[b]+'"',i[d].push(j));i[d]="("+i[d].join(", ")+")"}i=i.join(",\n\t");g.push("INSERT INTO "+k+" ("+f+") VALUES\n\t"+i)}g=g.join(";\n")+";";h.resolve(g)})}return h.promise()}};return m};f.VERSION="0.2";var p=Array.isArray||function(f){return!!(f&&f.constructor===Array)}})(this);(function(l,f){f.when=l.when;f.Deferred=l.Deferred;l.WebSQL=f})(jQuery,WebSQL);